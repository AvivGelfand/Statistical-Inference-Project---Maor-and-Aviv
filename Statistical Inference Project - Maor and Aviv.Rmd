---
title: "Inferencial Statistics Project"
author: "Aviv Gelfand and Maor Moshe  -  03/12/2022"
output:
  html_document: 
    fig_height: 4
    df_print: kable
    fig_width: 6
  word_document: default
editor_options:
  chunk_output_type: console
---


#### Recall of our previous project
Recall that in the previews project we used WHO table of Average BMI and life expectancy for 177 countries in the world.
[Source](https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who?resource=download).

**Predicted / dependent variable Y**: Life expectancy - refers to average number of years a person can expect to live in a country.

**Undependable variable X**: BMI - Body Mass Index units. A calculation using a person's height and weight. 

**We hypothesized** that BMI is an explanatory variable for a person's life expectancy. 


```{r echo=FALSE, message=FALSE, warning=FALSE }
# getwd()
setwd("C:/Users/avivg/OneDrive/Documents/R/Statistical Analysis Course/Lab2") #Aviv's setwd
# setwd("C:/") #Maor's setwd, *aviv* commit it when you working
df <- read.csv("WHO_BMI_2015.csv")
Life.expectancy <- df$Life.expectancy
BMI <- df$BMI
```

#### 1) Point Estimators
```{r  echo=FALSE, ,message=FALSE, warning=FALSE}
#Q1 #Assume Y distributs norm and asses E(y) and var(y)
# by MLE method:
Y_mu_hat <- mean(Life.expectancy)
# Y_mu_hat

Y_sig_square_hat <- var(Life.expectancy)
# Y_sig_square_hat
# sqrt(Y_sig_square_hat)


#Hanfanim - moment method :
Y_mu_hat_mom <- mean(Life.expectancy)
# Y_mu_hat_mom

Ey_squre <- Y_mu_hat_mom^2
y_squre <- mean(Life.expectancy^2)
Y_sig_squre_hat_mom_MLE <- y_squre - Ey_squre
# Y_sig_squre_hat_mom

```
##### **1. a)** Estimating Expectency and Variance Y
נניח שלערך החזוי, תוחלת החיים הממוצעת במדינה, התפלגות נורמלית. אז נגדיר אומד לתוחלת לפי שיטת הנראות המקסימלית או לפי שיטת המומנטים (אותה דרך).

$\hat{\mu_y} := \overline{Y} = \frac{1}{n} \sum_{i = 1}^{n}y_i$ = `r round(Y_mu_hat,2)`

ונגדיר אומד לשונות לפי שיטת הנראות המקסימלית

$\hat{\sigma^2_y} := \overline{Y^2} - \overline{Y}^2= \frac{1}{n} \sum_{i = 1}^{n}(y_i-\overline{Y})^2  =$ `r round(Y_sig_squre_hat_mom_MLE,2)`

בנוסף, למדנו בכיתה על אומד חסר הטייה מקובל לשונות להתפלגות נורמלית כך ש:

$\hat{\sigma^2_y} := S^2_n :=\frac{1}{n-1}\sum_{i = 1}^{n}(y_i-\overline{Y})^2  =$ `r round(var(Life.expectancy),2)`

Both of the estimators are unbiased. We can see that mom estimator has smaller variety and hence smaller mse rate. therefore we will proceed the assignment with mom astimator.


```{r echo=FALSE, message=FALSE, warning=FALSE }
m <- min(BMI)
W<- BMI-m
W <-sort(W)
# W
# Moment method 
a_hat_moment <- round((mean(W)^2)/((mean(W^2))-(mean(W)^2)),2)
# a_hat_moment
# mean(BMI)^2
lambda_hat_moment <- round((mean(W))/((mean(W^2))-(mean(W)^2)),2)
# lambda_hat_moment
```

##### **1. b)** Estimating Expectency and Variance of X using Gamma
We denote the independent variable, BMI as $X$, then: 

Let $m=min(X)$ and Let $W:=X-m$ and assume $W \sim Gamma(\alpha, \lambda)$

Then, by the formulas we prooved in class, the point estimator of $\alpha$ would be:
$\hat{\alpha}=\frac{\overline{W}^2}{\overline{W}^2-\overline{W^2}}$ = `r a_hat_moment`

And the point estimator of $\lambda$ would be:
$\hat{\lambda}=\frac{\overline{W}^2}{\overline{W}^2-\overline{W^2}}$ = `r lambda_hat_moment`

Thus, $W:= X-m \sim Gamma(\alpha =$ `r a_hat_moment` $, \lambda =$ `r lambda_hat_moment` $)$



##### **1. c-d)** Theoretical and Empirical Quantiles [0.1,0.5,0.75,0.9] of X,Y and W: 
```{r echo=FALSE, message=FALSE, warning=FALSE }
#1.c
quantiles <- c(0.1,0.5,0.75,0.9)
quants <- c(0.1,0.5,0.75,0.9)
Y_Theoretical <- qnorm(quantiles, mean = Y_mu_hat_mom, sd = sd(Life.expectancy) )

X_Theoretical <-  qgamma(quantiles, shape = a_hat_moment, scale = lambda_hat_moment) + m

W_Theoretical <- qgamma(quantiles, shape = a_hat_moment, scale = lambda_hat_moment)
# quants_X
#1.d
X_Empirical= quantile(BMI, probs = quantiles) #for x
Y_Empirical = quantile(Life.expectancy, probs=quantiles) # for y
W_Empirical = quantile(W, probs=quants)
library(dplyr)
df1 = data.frame( rbind(Y_Theoretical,Y_Empirical,X_Theoretical,X_Empirical,W_Theoretical,W_Empirical))
colnames(df1) <- c(0.1,0.5,0.75,0.9)
df1
```

We can see a similarity between the theoretical and the empirical parameters.



```{r echo=FALSE, message=FALSE, warning=FALSE }

#1.e hanfanim 2
# # percentiles ??
# gamma_percentiles <- qgamma(percentiles, shape = a_hat_moment, scale = lambda_hat_moment)
# plot(ecdf(W))
# points(ecdf(gamma_percentiles[1:100]),col='red')
# 
# 
# # Compute ECDFs
# W_ecdf <- ecdf(W)
# gamma_ecdf <- ecdf(gamma_percentiles[1:100])
# 
# # Set up the plot
# plot(W_ecdf, xlim = c(min(W, gamma_percentiles[1:100]), max(W, gamma_percentiles[1:100])),col='lightgreen' ,xlab = "Value", ylab = "ECDF", main = "theortical precentials to gamma precentails Comparison")
# 
# # Add the second ECDF to the plot
# lines(gamma_ecdf, col = "lightblue")
# 
# # Add a legend
# legend("bottomright", c("W", "gamma_percentiles"), col = c("blue", "red"), lty = 1)
```

# Question 2 - Confidence Intervals


```{r  Q2 }
# Question 2 - CI 

## for the expectancy
mean(Life.expectancy)
qnorm(0.985)
Upper_CI_miu_y <- mean(Life.expectancy) + qnorm(0.985)*sd(Life.expectancy)/(sqrt(length(Life.expectancy)))
Upper_CI_miu_y

Lower_CI_miu_y <-mean(Life.expectancy) - qnorm(0.985)*sd(Life.expectancy)/(sqrt(length(Life.expectancy))) 
Lower_CI_miu_y
Miu_CI <- c(Lower_CI_miu_y,Upper_CI_miu_y) 
Miu_CI #70.50 #73.14
# we can see that the value of x_hat is in the range 
mean(Life.expectancy)
 
## for the varience of life expectancy 

n<-length(Life.expectancy)
lower_ci_sigma_y<-(n-1)*var(Life.expectancy)/qchisq(0.955,n-1)
lower_ci_sigma_y

upper_ci_sigma_y <- 
(n-1)*var(Life.expectancy)/qchisq(0.045,n-1)
upper_ci_sigma_y
Sigma_CI <- c(lower_ci_sigma_y,upper_ci_sigma_y)
Sigma_CI #54.94 #78.94
 # we can see that the value of Sy is in the range -->
var(Life.expectancy)

```

# Question 3 - H

H0: תוחלת אורך החיים של "העולם השמן" יהיה זהה לתוחלת אורך החיים של "העולם הרזה". במילים אחרות - השערת ה0 טוענת שאין תלות בין בימאמאי לתוחלת אורך החיים

העולם השמן - מדינות בהן הביאמאי גדול מחציון הביאמאי בעולם
העולם הרזה - מדינות בהן הבימי גדול מחציון הביאמאי בעולם

H1: תוחלת אורך החיים של העולם השמן _קצרה_ מתוחלת אורך החיים של העולם הרזה

הסבר: אנחנו משערים שהשמנה גוררת ירידה בתוחלת משך החיים ולכן בתוחלת, אורך החיים של העולם השמן יהיה קצר יותר מאורך החיים של העולם הרזה. (ניתן להיזכר בעבודה הקודמת שמקדם המתאם בין אורך חיים להשמנה היה 0.36 כדי לקבל רמז/סיגנל שהקשר קיים). 

We want to test if there are times in the day in which earthquakes are more or less commons. Let $t_i$ be the time of each earthquake $i$ in the day (between $00:00:00$ and $23:59:59$), in units of hours, calculated in (d.). <br> 

Test the null hypothesis $H_0: t_i \sim U[0, 24]$ against the complex alternative 
$$H_0: \mu_{y|x_i > med(X)} = \mu_{y|x_i<med(X)} $$
$$H_1: \mu_{y|x_i > med(X)} < \mu_{y|x_i<med(X)}$$
<br>


In statistical testing, a test statistic is a numerical measure that is used to evaluate the evidence in a sample against a hypothesis. It is calculated from the sample data and is used to decide whether the sample provides sufficient evidence to reject the hypothesis - therfore its $mean(x)$

If the null hypothesis states that the means of two groups are equal, it is assuming that the groups are evenly distributed, or that there is no difference between the groups.


```{r Q3a }
df_low <- df[df$BMI<median(df$BMI),]
df_high <- df[df$BMI>=median(df$BMI),]

mean(df_low$Life.expectancy)
mean(df_high$Life.expectancy)

# mean(BMI)
# median(BMI)

y_lower <- df_low$Life.expectancy
y_high <- df_high$Life.expectancy
hist(y_lower)
hist(y_high)
#search for the p-value
#since we don't know the presice variance of the life expctancy we will use t test 
```


```{r}
D_s <-  y_high - y_lower
S2D <- var(y_high) + var(y_lower)  # cov is 0
meanDS <- mean(D_s)
p_value = pt(meanDS / (sqrt(S2D/length(y_lower))) ,df = length(y_lower)-1)
p_value
```

 This is a very small p-value, which suggests that the difference in means between the two groups is statistically significant. In other words, the data provides strong evidence against the null hypothesis, which states that the means of the two groups are equal.

Based on the p-value, we can conclude that the mean of the "low BMI" group is significantly different from the mean of the "high BMI" group.

However, it's important to remember that a p-value of 0 does not necessarily mean that the null hypothesis is definitively false. It simply means that the data provides strong evidence against the null hypothesis.

```{r}
#3.d

alpah = 0.03
p.value = 2.798601e-16
```
p-value that is less than our significance level, then we can conclude that the null hypothesis is rejected